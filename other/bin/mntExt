#!/bin/bash

#"bash strict mode"
set -uo pipefail

#check if run as root
if [ "$EUID" -ne 0 ]; then 
  echo "Please run it as root!"
  exit 1
fi

#get supplied mountpoint
if [ -v 1 ]; then
    MOUNTPOINT=$1
else
    echo "Please supply a mountpoint!"
    exit 1
fi

# modified version of https://askubuntu.com/a/1386907
choose_from_menu() {
    local prompt="$1" outvar="$2"
    shift
    shift
    local options=("$@") cur=0 count=${#options[@]} index=0
    local esc=$(echo -en "\e")
    printf "\e[1m\e[9%sm%s\e[0m%s\n" "3" ":: " "$prompt"
    while true
    do
        index=0 
        for o in "${options[@]}"
        do
            if [ "$index" == "$cur" ]
            then echo -e "> \e[1m\e[92m$o\e[0m"
            else echo -e "  \e[90m$o\e[0m"
            fi
            index=$(( $index + 1 ))
        done
        read -s -n3 key
        if [[ $key == $esc[A ]]
        then cur=$(( $cur - 1 ))
            [ "$cur" -lt 0 ] && cur=0
        elif [[ $key == $esc[B ]]
        then cur=$(( $cur + 1 ))
            [ "$cur" -ge $count ] && cur=$(( $count - 1 ))
        elif [[ $key == "" ]]
        then break
        fi
        echo -en "\e[${count}A"
    done
    printf -v $outvar "${options[$cur]}"
}

# drive chooser
chooseDrive() {
    selections=$(lsblk -l | grep -E 'sd[a-zA-Z][0-9]|nvme[0-9]n[0-9]p[0-9]' | tr -s ' ' ' ' | cut -d ' ' -f 1)
    adj_selections=""
    for d in $selections; do
        mountStat=$(lsblk -l | grep "$d" | tr -s ' ' ' ' | cut -d ' ' -f 7)
        if [ -z $mountStat ]; then
            adj_selections="$adj_selections""$d "
        fi
    done
    choose_from_menu "What Drive to mount?" selected_choice ${adj_selections[@]}
    DRIVE=$selected_choice
}

# fs chooser
chooseFS() {
    selections=(
        "ntfs3"
        "ext4"
        "auto"
    )
    choose_from_menu "What filesystem to mount with?" selected_choice ${selections[@]}
    FS=$selected_choice
}

# mount drive after selections
handleMount() {
    driveSpace=$(lsblk -l | grep "$DRIVE" | tr -s ' ' ' ' | cut -d ' ' -f 4)
    DRIVE="/dev/""$DRIVE"
    printf "\e[1m\e[9%sm%s\e[0m%s\n" "2" ":: " "Mounting \"$DRIVE\" ($driveSpace) with \"$FS\" to \"$MOUNTPOINT\""
    selections=(
        "no"
        "yes"
    )
    choose_from_menu "Correct?" selected_choice ${selections[@]}
    if [ "$selected_choice" == "yes" ]; then
        mount -t $FS $DRIVE $MOUNTPOINT
        if [ $? ]; then
            clear
            printf "\e[1m\e[9%sm%s\e[0m%s\n" "2" ":: " "Successfully mounted!"
        else
            printf "\e[1m\e[9%sm%s\e[0m%s\n" "1" ":: " "Some Error occured!"
        fi
        printf "\e[1m\e[9%sm%s\e[0m%s\n" "1" ":: " "Exiting..."
        exit 0
    else
        clear
        printf "\e[1m\e[9%sm%s\e[0m%s\n" "1" ":: " "Exiting..."
        exit 1
    fi
}

chooseDrive
chooseFS
handleMount
